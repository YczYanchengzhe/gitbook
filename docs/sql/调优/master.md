# 数据库的主从同步


## 一.为什么会有主从同步
从目的出发,如果我们希望提高数据库高并发访问的效率,那么从维护成本上来说,可以采用下面的方式,下面的方式维护成本是由低到高的 : 
- 优化SQL 和索引
- 采用缓存
- 对数据库采用主从架构进行读写分离

## 二. 主从架构优点
- 读写分离
- 数据备份
- 高可用

## 三. 主从同步的原理
> binlog : 二进制日志,记录了对数据库进行更新的事件.

### 3.1 主从复制流程

- 主库在有数据更新时候会有一个线程将数据写入binlog
- 数据发送给从库,从库收到数据之后存在一个线程将数据拷贝到本地形成中继日志(Relay log)
- 从库中存在一个线程执行中继日志中的事件,进行数据同步

![img](../../resources/sql/637d392dbcdacf14cbb2791085a62b31.png)

### 3.2 主从同步的数据一致性

- 异步复制 : 客户端提交COMMIT之后不需要等待从库返回任何结果,直接将结果返回给客户端
  - 不会影响主库写的效率,但是可能存在因为主库宕机导致binlog数据丢失,此时一致性最弱


- 半同步 : 等待一个从节点返回acf之后再将数据返回

  - 增加了一个网络连接的延迟,降低了主库写的效率,提高一致性

```sql
-- 可以通过这个参数设置从库应答ack的数量
rpl_semi_sync_master_wait_for_slave_count
```


- 组复制 : MGR(MySQL Group Replication).MySQL 在 5.7.17 版本中推出的一种新的数据复制技术,基于Paxos.

  - 至少半数节点回复ack才会返回数据.



# 数据恢复

# 一. InnoDB存储引擎的表空间

> InnoDB 存储引擎的文件格式是.ibd 文件，数据会按照表空间（tablespace）进行存储，分为共享表空间和独立表空间。

```sql
-- 查询 : ON 表示独立表空间，而 OFF 则表示共享表空间
show variables like 'innodb_file_per_table';
```

- 共享表空间 : InnoDB 存储的表数据都会放到共享表空间中，也就是多个数据表共用一个表空间，同时表空间也会自动分成多个文件存放到磁盘上.
  - 单个数据表的大小可以突破文件系统大小的限制，最大可以达到 64TB
  - 多个数据表存放到一起，结构不清晰，不利于数据的找回
- 独立表空间 : 每个数据表都有自己的物理文件
  - 每张表都相互独立，不会影响到其他数据表，存储结构清晰，利于数据恢复
  - 数据表还可以在不同的数据库之间进行迁移

# 二. ibd文件损害如何找回

- mysqlbinlog,binlog2sql - 根据binlog恢复
- Percona Data Recovery Tool for InnoDB - 根据ibd文件进行回复

### InnoDB自动恢复机制

```sql
-- 默认为 0，表示不进行强制恢复,如果ibd 文件中的数据页发生损坏，则无法读取数据
show variables like 'innodb_force_recovery';
```

- innodb_force_recovery参数一共有 7 种状态，除了默认的 0 以外，还可以为 1-6 的取值，分别代表不同的强制恢复措施。
- 当我们需要强制恢复的时候，可以将innodb_force_recovery设置为 1，表示即使发现了损坏页也可以继续让服务运行，这样我们就可以读取数据表，并且对当前损坏的数据表进行分析和备份。
- 通常innodb_force_recovery参数设置为 1，只要能正常读取数据表即可。但如果参数设置为 1 之后还无法读取数据表，我们可以将参数逐一增加，比如 2、3 等
- 当innodb_force_recovery设置为大于 0 时，相当于对 InnoDB 进行了写保护，只能进行 SELECT 读取操作，还是有限制的读取，对于 WHERE 条件以及 ORDER BY 都无法进行操作。

### InnoDB自动恢复流程

- 使用innodb_force_recovery启动服务器
- 备份数据表 : 这里需要使用 MyISAM 存储引擎,因为InnoDB 存储引擎已经写保护了，无法将数据备份出来
- 删除旧表，改名新表
- 关闭innodb_force_recovery，并重启数据库















