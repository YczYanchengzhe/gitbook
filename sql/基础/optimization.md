# 数据库调优



# 一.调优思路

## 1.定位数据库瓶颈

- 用户的反馈
- 日志分析
- 服务器资源使用监控 : CPU/内存/IO
- 数据库内部状况监控 : 活跃会话/事务/锁

## 2.可调优的维度

- 选择合适的DBMS : MySQL / NoSQL , InnoDb/MyISAM
- 优化表的设计 : 
  - 表结构尽量遵循第三范式
  - 对于分析查询较多的应用,可以通过反范式来优化,增加冗余字段,空间换时间的思路.
  - 表字段的选择 :  一般来说，如果字段可以采用数值类型就不要采用字符类型；字符长度要尽可能设计得短一些。针对字符类型来说，当确定字符长度固定时，就可以采用 CHAR 类型；当长度不固定时，通常采用 VARCHAR 类型。 
- 优化逻辑查询
  - SQL查询优化
    - 逻辑查询优化 
    - 物理查询优化

> SQL 中 char和varchar的区别
>
> char : 定长字符,如果数据长度确定可以使用该方式存储
>
> varchar : 变长字符 ,但是存储效率没有char高,对于一个字段可能值是不固定长度的,我们只知道它不可能超过10个字符,那么定义为varchar(10)最合算.varchar存储时的类型比实际上长度+1,用于存储实际用了多大的长度.

>逻辑查询优化 :通过改变SQL语句内容,重写SQL 主要包含 -> 子查询优化 , 等价谓词重写,视图重写,条件简化 ,链接消除 , 嵌套链接消除

>例如 : 
>
>EXIST 子查询和IN 子查询 ,使用小表驱动大表
>
>WHERE 子句尽量避免对于字段进行函数运算 , 会导致索引失效

> 物理查询优化 : **创建索引考量,访问路径考量**
>
> 将逻辑查询的内容变成可以被执行的物理操作符,从而为后续执行器的执行提供准备.核心是高效建立索引,并通过索引来进行各种优化.
>
> 其主要是在确定了逻辑查询优化之后,采用物理优化技术(索引等),通过计算代价模型对各种可能访问路径进行估算,从而找到执行方式中代价最小的执行计划.



## 3.创建索引的考量

(1) 不要对数据重复度较高字段创建索引

(2)注意索引列位置对于索引的影响(where后的表达式计算会导致计算字段的索引失效)

(3)联合索引对索引使用的影响 : 最左匹配原则

(4)多个索引对于索引使用的影响 : 

​	1>索引越多存储空间越多

​	2>增大了优化器评估阶段筛选索引的时间



## 4.访问路径的考量

(1)单表扫描 : 全表扫描还是局部扫描

(2)两表连接 : 嵌套循环连接 , HASH连接 , 合并连接(SQL Server 提供的[联接](https://docs.microsoft.com/zh-cn/previous-versions/sql/sql-server-2008/ms191426(v=sql.100)?redirectedfrom=MSDN)操作)

(3)多表链接 : 注意链接顺序



## 5.存储选择的考量

> 使用redis 还是 memcached 作为缓存

可靠性 : Redis支持持久化 , memcaches 不支持

数据类型 : Redis 支持的数据类型比memcache多



## 6.库级优化

> 读写分离 , 分库分表

> 分库分表 : 垂直拆分 ,水平拆分

- 数据库中数据表过多 , 可以采用垂直分库
- 数据库中单表数据列过多 , 可以采用垂直分表
- 数据库中单表数据量过大 , 水平拆分